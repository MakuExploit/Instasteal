local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

local isTeleporting = false
local noclipEnabled = false
local noclipConn = nil

local fastStealOn = false
local fastStealConn = nil

-- CHARACTER
local function getCharacter()
    local char = LocalPlayer.Character
    if not char or not char.Parent then
        char = LocalPlayer.CharacterAdded:Wait()
    end
    return char
end

-- PLOT
local function getMyPlot()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then return nil end

    for _, plot in ipairs(plots:GetChildren()) do
        local label =
            plot:FindFirstChild("PlotSign")
            and plot.PlotSign:FindFirstChild("SurfaceGui")
            and plot.PlotSign.SurfaceGui:FindFirstChild("Frame")
            and plot.PlotSign.SurfaceGui.Frame:FindFirstChild("TextLabel")

        if label then
            local t = label.ContentText or label.Text or ""
            if t:find(LocalPlayer.DisplayName) and t:find("Base") then
                return plot
            end
        end
    end
    return nil
end

local function getDeliveryHitbox()
    local plot = getMyPlot()
    if not plot then return nil end
    local d = plot:FindFirstChild("DeliveryHitbox", true)
    if d and d:IsA("BasePart") then
        return d
    end
end

-- NOCLIP
local function setNoclip(on)
    noclipEnabled = on
    if on then
        noclipConn = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if not char then return end
            for _, p in ipairs(char:GetDescendants()) do
                if p:IsA("BasePart") then
                    p.CanCollide = false
                end
            end
        end)
    else
        if noclipConn then noclipConn:Disconnect() noclipConn = nil end
        local char = LocalPlayer.Character
        if char then
            for _, p in ipairs(char:GetDescendants()) do
                if p:IsA("BasePart") then
                    p.CanCollide = true
                end
            end
        end
    end
end

-- TELEPORT
local function shortTeleportFreezeCamera(cf)
    if isTeleporting then return end
    isTeleporting = true

    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local cam = workspace.CurrentCamera
    if not hrp or not cam then isTeleporting = false return end

    local oldCF = hrp.CFrame
    local oldCamCF = cam.CFrame

    cam.CameraType = Enum.CameraType.Scriptable
    hrp.CFrame = cf
    task.wait(0.25)
    hrp.CFrame = oldCF
    cam.CFrame = oldCamCF
    cam.CameraType = Enum.CameraType.Custom

    isTeleporting = false
end

local function doInstantSteal()
    local d = getDeliveryHitbox()
    if not d then return end
    shortTeleportFreezeCamera(d.CFrame + d.CFrame.LookVector * 3 + Vector3.new(0,3,0))
end

local function doForwardTP()
    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = hrp.CFrame + hrp.CFrame.LookVector * 8
    end
end

-- FAST STEAL
local function patchPrompt(p)
    if p:IsA("ProximityPrompt") then
        p.HoldDuration = 0.01
    end
end

local function setFastSteal(on)
    fastStealOn = on
    if fastStealConn then fastStealConn:Disconnect() end

    if on then
        fastStealConn = RunService.Heartbeat:Connect(function()
            for _, o in ipairs(workspace:GetDescendants()) do
                if o:IsA("ProximityPrompt") then
                    patchPrompt(o)
                end
            end
        end)
    end
end

-- UI
local gui = Instance.new("ScreenGui", game:GetService("CoreGui"))
gui.Name = "SAB_Utils_UI"
gui.ResetOnSpawn = false

-- MAIN FRAME
local main = Instance.new("Frame", gui)
main.Size = UDim2.new(0,240,0,240)
main.Position = UDim2.new(0.68,-120,0.55,-120)
main.BackgroundColor3 = Color3.fromRGB(25,10,10)
main.BorderSizePixel = 0
Instance.new("UICorner", main).CornerRadius = UDim.new(0,18)

local stroke = Instance.new("UIStroke", main)
stroke.Color = Color3.fromRGB(180,40,40)
stroke.Thickness = 1.5

-- HEADER
local header = Instance.new("Frame", main)
header.Size = UDim2.new(1,0,0,42)
header.BackgroundColor3 = Color3.fromRGB(120,25,25)
header.BorderSizePixel = 0
Instance.new("UICorner", header).CornerRadius = UDim.new(0,18)

local grad = Instance.new("UIGradient", header)
grad.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(160,40,40)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(80,15,15))
}

local title = Instance.new("TextLabel", header)
title.Size = UDim2.new(1,0,1,0)
title.BackgroundTransparency = 1
title.Text = "Instant Steal Free"
title.Font = Enum.Font.GothamBlack
title.TextSize = 18
title.TextColor3 = Color3.new(1,1,1)

-- DRAG
do
    local dragging, startPos, dragStart
    header.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = i.Position
            startPos = main.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    UserInputService.InputChanged:Connect(function(i)
        if dragging then
            local d = i.Position - dragStart
            main.Position = UDim2.new(startPos.X.Scale,startPos.X.Offset + d.X,startPos.Y.Scale,startPos.Y.Offset + d.Y)
        end
    end)
end

-- BODY
local body = Instance.new("Frame", main)
body.Size = UDim2.new(1,-20,1,-60)
body.Position = UDim2.new(0,10,0,50)
body.BackgroundTransparency = 1

local layout = Instance.new("UIListLayout", body)
layout.Padding = UDim.new(0,8)

local function makeBtn(text)
    local b = Instance.new("TextButton", body)
    b.Size = UDim2.new(1,0,0,36)
    b.BackgroundColor3 = Color3.fromRGB(150,35,35)
    b.Text = text
    b.Font = Enum.Font.GothamBold
    b.TextSize = 14
    b.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
    return b
end

local instantBtn = makeBtn("INSTANT STEAL")
local forwardBtn = makeBtn("TP FORWARD")
local noclipBtn = makeBtn("NOCLIP: OFF")
local fastBtn = makeBtn("FAST STEAL: OFF")

instantBtn.MouseButton1Click:Connect(doInstantSteal)
forwardBtn.MouseButton1Click:Connect(doForwardTP)

noclipBtn.MouseButton1Click:Connect(function()
    setNoclip(not noclipEnabled)
    noclipBtn.Text = noclipEnabled and "NOCLIP: ON" or "NOCLIP: OFF"
end)

fastBtn.MouseButton1Click:Connect(function()
    setFastSteal(not fastStealOn)
    fastBtn.Text = fastStealOn and "FAST STEAL: ON" or "FAST STEAL: OFF"
end)

-- TOGGLE BUTTON
local toggle = Instance.new("TextButton", gui)
toggle.Size = UDim2.new(0,46,0,46)
toggle.Position = UDim2.new(0.02,0,0.5,-23)
toggle.BackgroundColor3 = Color3.fromRGB(120,25,25)
toggle.Text = ""
Instance.new("UICorner", toggle).CornerRadius = UDim.new(1,0)

local icon = Instance.new("ImageLabel", toggle)
icon.Size = UDim2.new(1,0,1,0)
icon.BackgroundTransparency = 1
icon.Image = "rbxassetid://117995088410104"

toggle.MouseButton1Click:Connect(function()
    main.Visible = not main.Visible
end)

do
    local dragging, startPos, dragStart
    toggle.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = i.Position
            startPos = toggle.Position
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    UserInputService.InputChanged:Connect(function(i)
        if dragging then
            local d = i.Position - dragStart
            toggle.Position = UDim2.new(startPos.X.Scale,startPos.X.Offset + d.X,startPos.Y.Scale,startPos.Y.Offset + d.Y)
        end
    end)
end
